{% extends 'layout/base.html' %}
{% block title %}Quản lý Dịch vụ{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fa-solid fa-bell-concierge me-2"></i>Quản lý Dịch vụ</h2>
        <div>
            <span class="badge bg-inuse fs-6 me-2">
                <i class="fa-solid fa-door-open me-1"></i>
                {{ active_rooms|length }} phòng đang hoạt động
            </span>
            <span class="badge bg-success fs-6">
                <i class="fa-solid fa-utensils me-1"></i>
                {{ services|length }} dịch vụ
            </span>
        </div>
    </div>

    {% if active_rooms %}
    <div class="row">
        <!-- PHẦN BÊN TRÁI: Danh sách phòng -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                <div class="card-header bg-inuse text-white">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-list me-2"></i>Chọn phòng
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="roomList">
                        {% for room_info in active_rooms %}
                        <a href="#" 
                           class="list-group-item list-group-item-action room-item {% if loop.first %}active{% endif %}" 
                           data-room-id="{{ room_info.room.id }}"
                           data-bill-id="{{ room_info.bill.id }}"
                           onclick="selectRoom({{ room_info.room.id }}, {{ room_info.bill.id }}, '{{ room_info.room.name }}'); return false;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="fa-solid fa-door-open me-2"></i>
                                        <strong>{{ room_info.room.name }}</strong>
                                    </h6>
                                    <small class="text-muted">
                                        <i class="fa-solid fa-user me-1"></i>
                                        {{ room_info.bill.customer.full_name }}
                                    </small>
                                    <br>
                                    <small class="text-muted">
                                        <i class="fa-solid fa-clock me-1"></i>
                                        Bắt đầu: {{ room_info.bill.start_time.strftime('%H:%M') }}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-second">
                                        {{ room_info.current_services_count }} món
                                    </span>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- PHẦN GIỮA: Menu dịch vụ -->
        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fa-solid fa-utensils me-2"></i>Menu Dịch vụ
                        </h5>
                        <input type="text" 
                               class="form-control form-control-sm" 
                               id="searchService" 
                               placeholder="Tìm kiếm..." 
                               style="width: 200px;">
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="serviceList">
                        {% for service in services %}
                        <div class="list-group-item service-item" data-service-name="{{ service.name }}">
                            <div class="row align-items-center">
                                <div class="col-7">
                                    <h6 class="mb-1">
                                        {% if service.category == 'Beverage' %}
                                            <i class="fa-solid fa-wine-glass text-info me-2"></i>
                                        {% elif service.category == 'Food' %}
                                            <i class="fa-solid fa-bowl-food text-warning me-2"></i>
                                        {% else %}
                                            <i class="fa-solid fa-box text-secondary me-2"></i>
                                        {% endif %}
                                        {{ service.name }}
                                    </h6>
                                    <small class="text-muted">{{ service.unit }}</small>
                                </div>
                                <div class="col-3 text-end">
                                    <strong class="text-primary">{{ "{:,.0f}".format(service.price) }}đ</strong>
                                </div>
                                <div class="col-2 text-end">
                                    <button class="btn btn-sm btn-outline-success btn-add-service" 
                                            data-service-id="{{ service.id }}"
                                            data-service-name="{{ service.name }}"
                                            data-service-price="{{ service.price }}"
                                            onclick="openQuantityModal({{ service.id }}, '{{ service.name }}', {{ service.price }})">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- PHẦN BÊN PHẢI: Giỏ dịch vụ (Chi tiết bill) -->
        <div class="col-lg-3 mb-4">
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-shopping-cart me-2"></i>
                        Dịch vụ đã gọi
                    </h5>
                </div>
                <div class="card-body" id="serviceCart">
                    <div class="text-center text-muted py-4" id="emptyCart">
                        <i class="fa-solid fa-inbox fa-3x mb-3"></i>
                        <p>Chọn phòng để xem dịch vụ</p>
                    </div>
                </div>
                <div class="card-footer bg-light" id="cartFooter" style="display: none;">
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Tổng tiền:</strong>
                        <strong class="text-primary fs-5" id="totalServicePrice">0đ</strong>
                    </div>
                    <button class="btn btn-primary w-100" onclick="refreshServices()">
                        <i class="fa-solid fa-sync me-2"></i>Làm mới
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Không có phòng nào đang hoạt động -->
    <div class="text-center py-5">
        <i class="fa-solid fa-door-closed fa-5x text-muted mb-3"></i>
        <h3 class="text-muted">Không có phòng nào đang hoạt động</h3>
        <p class="text-muted">Vui lòng đặt phòng trước khi thêm dịch vụ</p>
        <a href="{{ url_for('booking') }}" class="btn btn-primary mt-3">
            <i class="fa-solid fa-calendar me-2"></i>Đặt phòng ngay
        </a>
    </div>
    {% endif %}
</div>

<!-- Modal nhập số lượng -->
<div class="modal fade" id="quantityModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-second text-white">
                <h5 class="modal-title">
                    <i class="fa-solid fa-plus-circle me-2"></i>Thêm dịch vụ
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addServiceForm">
                    <input type="hidden" id="modalServiceId">
                    <input type="hidden" id="modalBillId">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Phòng:</label>
                        <p class="text-primary fs-5" id="modalRoomName">-</p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Dịch vụ:</label>
                        <p class="text-dark fs-5" id="modalServiceName">-</p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Đơn giá:</label>
                        <p class="text-success fs-5" id="modalServicePrice">-</p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="serviceQuantity" class="form-label fw-bold">Số lượng:</label>
                        <div class="input-group input-group-lg">
                            <button type="button" class="btn btn-outline-secondary" onclick="decreaseQuantity()">
                                <i class="fa-solid fa-minus"></i>
                            </button>
                            <input type="number" 
                                   class="form-control text-center fs-4" 
                                   id="serviceQuantity" 
                                   value="1" 
                                   min="1" 
                                   max="99"
                                   required>
                            <button type="button" class="btn btn-outline-secondary" onclick="increaseQuantity()">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Thành tiền: </strong>
                        <span class="fs-4 text-primary" id="modalTotalPrice">0đ</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa-solid fa-times me-2"></i>Hủy
                </button>
                <button type="button" class="btn btn-success btn-lg" onclick="addServiceToRoom()">
                    <i class="fa-solid fa-check me-2"></i>Xác nhận
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #764ba2 0%, #764ba2 100%);
}

.bg-gradient-success {
    background: linear-gradient(135deg, #56ab2f 0%, #56ab2f 100%);
}

.bg-gradient-info {
    background: linear-gradient(135deg, #4facfe 0%, #4facfe 100%);
}

.room-item {
    cursor: pointer;
    transition: all 0.3s;
    border-left: 4px solid transparent;
}

.room-item:hover {
    background-color: #f8f9fa;
    border-left-color: #667eea;
}

.room-item.active {
    background: linear-gradient(90deg, rgba(102,126,234,0.1) 0%, rgba(255,255,255,1) 100%);
    border-left-color: #667eea;
    font-weight: 500;
}

.service-item {
    transition: all 0.3s;
    cursor: pointer;
}

.service-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.btn-add-service {
    transition: all 0.3s;
}

.btn-add-service:hover {
    transform: scale(1.1);
}

.sticky-top {
    max-height: calc(100vh - 100px);
    overflow-y: auto;
}

.card {
    border-radius: 15px;
    overflow: hidden;
}

.breadcrumb {
    background-color: rgba(255, 255, 255, 0.9);
    padding: 1rem;
    border-radius: 10px;
}

#serviceCart {
    max-height: 400px;
    overflow-y: auto;
}

.service-cart-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    transition: all 0.3s;
}

.service-cart-item:hover {
    background-color: #f8f9fa;
}
.bg-second{
    background-color: #198754;
}
.bg-inuse{
    background-color: #dc3545;
}
.quantity-badge {
    min-width: 30px;
    height: 30px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}
</style>

<script>
// Biến global
let currentRoomId = null;
let currentBillId = null;
let currentRoomName = '';
let currentServicePrice = 0;

// Khởi tạo khi load trang
document.addEventListener('DOMContentLoaded', function() {
    // Tự động chọn phòng đầu tiên
    const firstRoom = document.querySelector('.room-item');
    if (firstRoom) {
        const roomId = firstRoom.dataset.roomId;
        const billId = firstRoom.dataset.billId;
        const roomName = firstRoom.querySelector('strong').textContent.trim();
        selectRoom(roomId, billId, roomName);
    }
    
    // Tìm kiếm dịch vụ
    document.getElementById('searchService').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('.service-item').forEach(item => {
            const serviceName = item.dataset.serviceName.toLowerCase();
            if (serviceName.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // Auto-update số lượng trong modal
    document.getElementById('serviceQuantity').addEventListener('input', updateModalTotal);
});

// Chọn phòng
function selectRoom(roomId, billId, roomName) {
    currentRoomId = roomId;
    currentBillId = billId;
    currentRoomName = roomName;
    
    // Update active state
    document.querySelectorAll('.room-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.room-item').classList.add('active');
    
    // Load dịch vụ đã gọi
    loadRoomServices(billId);
}

// Load danh sách dịch vụ đã gọi của phòng
function loadRoomServices(billId) {
    fetch(`/api/bill/${billId}/services`)
        .then(response => response.json())
        .then(data => {
            displayServices(data.services, data.total);
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Không thể tải dịch vụ');
        });
}

// Hiển thị dịch vụ trong giỏ
function displayServices(services, total) {
    const cart = document.getElementById('serviceCart');
    const emptyCart = document.getElementById('emptyCart');
    const footer = document.getElementById('cartFooter');
    
    if (services.length === 0) {
        cart.innerHTML = '<div class="text-center text-muted py-4"><i class="fa-solid fa-inbox fa-3x mb-3"></i><p>Chưa gọi dịch vụ nào</p></div>';
        footer.style.display = 'none';
        return;
    }
    
    let html = '';
    services.forEach(service => {
        html += `
            <div class="service-cart-item">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>${service.name}</strong>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeService(${service.detail_id})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">
                        <span class="quantity-badge bg-primary text-white">${service.quantity}</span>
                        × ${formatCurrency(service.price)}
                    </span>
                    <strong class="text-success">${formatCurrency(service.total)}</strong>
                </div>
            </div>
        `;
    });
    
    cart.innerHTML = html;
    document.getElementById('totalServicePrice').textContent = formatCurrency(total);
    footer.style.display = 'block';
}

// Mở modal nhập số lượng
function openQuantityModal(serviceId, serviceName, servicePrice) {
    if (!currentBillId) {
        showError('Vui lòng chọn phòng trước!');
        return;
    }
    
    document.getElementById('modalServiceId').value = serviceId;
    document.getElementById('modalBillId').value = currentBillId;
    document.getElementById('modalRoomName').textContent = currentRoomName;
    document.getElementById('modalServiceName').textContent = serviceName;
    document.getElementById('modalServicePrice').textContent = formatCurrency(servicePrice);
    document.getElementById('serviceQuantity').value = 1;
    
    currentServicePrice = servicePrice;
    updateModalTotal();
    
    const modal = new bootstrap.Modal(document.getElementById('quantityModal'));
    modal.show();
}

// Tăng/giảm số lượng
function increaseQuantity() {
    const input = document.getElementById('serviceQuantity');
    input.value = parseInt(input.value) + 1;
    updateModalTotal();
}

function decreaseQuantity() {
    const input = document.getElementById('serviceQuantity');
    if (parseInt(input.value) > 1) {
        input.value = parseInt(input.value) - 1;
        updateModalTotal();
    }
}

// Cập nhật tổng tiền trong modal
function updateModalTotal() {
    const quantity = parseInt(document.getElementById('serviceQuantity').value) || 1;
    const total = currentServicePrice * quantity;
    document.getElementById('modalTotalPrice').textContent = formatCurrency(total);
}

// Thêm dịch vụ vào phòng
function addServiceToRoom() {
    const serviceId = document.getElementById('modalServiceId').value;
    const billId = document.getElementById('modalBillId').value;
    const quantity = parseInt(document.getElementById('serviceQuantity').value);
    
    if (!quantity || quantity < 1) {
        showError('Số lượng không hợp lệ!');
        return;
    }
    
    // Hiển thị loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Đang xử lý...';
    
    fetch('/api/bill/add-service', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            bill_id: billId,
            service_id: serviceId,
            quantity: quantity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Thêm dịch vụ thành công!');
            bootstrap.Modal.getInstance(document.getElementById('quantityModal')).hide();
            loadRoomServices(billId);
            
            // Cập nhật số lượng món trong list phòng
            updateRoomServiceCount(billId);
        } else {
            showError(data.message || 'Có lỗi xảy ra!');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Không thể thêm dịch vụ!');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// Xóa dịch vụ
function removeService(detailId) {
    if (!confirm('Bạn có chắc muốn xóa dịch vụ này?')) {
        return;
    }
    
    fetch(`/api/bill/remove-service/${detailId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Đã xóa dịch vụ!');
            loadRoomServices(currentBillId);
            updateRoomServiceCount(currentBillId);
        } else {
            showError(data.message || 'Không thể xóa!');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Có lỗi xảy ra!');
    });
}

// Cập nhật số lượng dịch vụ trong danh sách phòng
function updateRoomServiceCount(billId) {
    const roomItem = document.querySelector(`[data-bill-id="${billId}"]`);
    if (roomItem) {
        fetch(`/api/bill/${billId}/service-count`)
            .then(response => response.json())
            .then(data => {
                const badge = roomItem.querySelector('.badge');
                badge.textContent = `${data.count} món`;
            });
    }
}

// Làm mới
function refreshServices() {
    if (currentBillId) {
        loadRoomServices(currentBillId);
        showSuccess('Đã làm mới!');
    }
}

// Format tiền
function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
    }).format(amount);
}

// Hiển thị thông báo
function showSuccess(message) {
    // Sử dụng toast hoặc alert
    alert(message);
}

function showError(message) {
    alert(message);
}
</script>
{% endblock %}